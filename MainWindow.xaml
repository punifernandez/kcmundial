<Window x:Class="KCMundial.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="KC Mundial" 
        WindowStyle="None"
        Width="1200"
        Height="800"
        ResizeMode="NoResize"
        WindowStartupLocation="CenterScreen"
        WindowState="Maximized"
        Background="Black"
        KeyDown="Window_KeyDown">
    <Grid>
        <!-- Preview Area - SIEMPRE VISIBLE -->
        <Image x:Name="PreviewImage" 
               Stretch="UniformToFill" 
               HorizontalAlignment="Stretch" 
               VerticalAlignment="Stretch"
               Visibility="Visible"
               Panel.ZIndex="0">
            <Image.LayoutTransform>
                <ScaleTransform ScaleX="-1" ScaleY="1"/>
            </Image.LayoutTransform>
        </Image>

        <!-- Preview Overlay - Guía de posición de cabeza -->
        <Canvas x:Name="PreviewOverlay"
                Panel.ZIndex="100"
                Visibility="{Binding IsPreviewActive, Converter={StaticResource BoolToVisibilityConverter}}"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch"
                Loaded="PreviewOverlay_Loaded"
                SizeChanged="PreviewOverlay_SizeChanged">
            <!-- Guía rectangular para cabeza y hombros -->
            <Rectangle x:Name="HeadGuide"
                      Width="500"
                      Height="650"
                      Stroke="#FFD700"
                      StrokeThickness="4"
                      StrokeDashArray="10,5"
                      Fill="Transparent"
                      Opacity="0.9">
                <Rectangle.Effect>
                    <DropShadowEffect Color="#FFD700" 
                                      Direction="270" 
                                      ShadowDepth="0" 
                                      Opacity="0.7" 
                                      BlurRadius="10"/>
                </Rectangle.Effect>
            </Rectangle>
            
            <!-- Texto de ayuda -->
            <TextBlock x:Name="HeadGuideText"
                      Text="Posicioná tu cabeza y hombros aquí"
                      FontFamily="{DynamicResource TheSeasonsFont}"
                      FontSize="24"
                      Foreground="White"
                      Opacity="0.9">
                <TextBlock.Effect>
                    <DropShadowEffect Color="#000000" 
                                      Direction="270" 
                                      ShadowDepth="2" 
                                      Opacity="0.8" 
                                      BlurRadius="8"/>
                </TextBlock.Effect>
            </TextBlock>
        </Canvas>

        <!-- Log Status Indicator - Top Left - SIEMPRE VISIBLE -->
        <TextBlock x:Name="LogStatusText"
                   HorizontalAlignment="Left"
                   VerticalAlignment="Top"
                   Margin="16,16,0,0"
                   FontSize="12"
                   Foreground="Yellow"
                   Background="#80000000"
                   Padding="8,4"
                   Panel.ZIndex="2000"
                   TextWrapping="Wrap"
                   MaxWidth="600"
                   Visibility="Visible"
                   IsHitTestVisible="False">
            <TextBlock.Effect>
                <DropShadowEffect Color="#000000" 
                                  Direction="270" 
                                  ShadowDepth="2" 
                                  Opacity="0.9" 
                                  BlurRadius="4"/>
            </TextBlock.Effect>
        </TextBlock>

        <!-- Top Bar - Printer, Camera and Close Buttons (Circular Purple) -->
        <StackPanel Orientation="Horizontal" 
                   HorizontalAlignment="Right" 
                   VerticalAlignment="Top"
                   Margin="16,16,16,0"
                   Panel.ZIndex="1000">
            <!-- Printer Button -->
            <Button x:Name="PrinterButton"
                    Foreground="White"
                    Background="#8c52ff"
                    BorderThickness="0"
                    Width="50"
                    Height="50"
                    Margin="0,0,8,0"
                    Click="PrinterButton_Click"
                    Cursor="Hand">
                <Button.Template>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" 
                                CornerRadius="25"
                                Width="50"
                                Height="50"
                                BorderBrush="White"
                                BorderThickness="2">
                            <Image x:Name="PrinterIconImage"
                                   Width="28" 
                                   Height="28"
                                   Stretch="Uniform"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Button.Template>
                <Button.Style>
                    <Style TargetType="Button">
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#7a3fe6"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>
            
            <!-- Camera Button -->
            <Button x:Name="CameraButton"
                    Foreground="White"
                    Background="#8c52ff"
                    BorderThickness="0"
                    Width="50"
                    Height="50"
                    Margin="0,0,8,0"
                    Click="CameraButton_Click"
                    Cursor="Hand">
                <Button.Template>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" 
                                CornerRadius="25"
                                Width="50"
                                Height="50"
                                BorderBrush="White"
                                BorderThickness="2">
                            <Image x:Name="CameraIconImage"
                                   Width="28" 
                                   Height="28"
                                   Stretch="Uniform"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Button.Template>
                <Button.Style>
                    <Style TargetType="Button">
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#7a3fe6"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>
            
            <!-- Close Button -->
            <Button x:Name="CloseButton"
                    Foreground="White"
                    Background="#8c52ff"
                    BorderThickness="0"
                    Width="50"
                    Height="50"
                    Click="CloseButton_Click"
                    Cursor="Hand">
                <Button.Template>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" 
                                CornerRadius="25"
                                Width="50"
                                Height="50"
                                BorderBrush="White"
                                BorderThickness="2">
                            <Image x:Name="CancelIconImage"
                                   Width="28" 
                                   Height="28"
                                   Stretch="Uniform"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Button.Template>
                <Button.Style>
                    <Style TargetType="Button">
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#7a3fe6"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>
        </StackPanel>

        <!-- Printer Selection Popup -->
        <Border x:Name="PrinterPopup"
                Background="White"
                BorderBrush="#8c52ff"
                BorderThickness="2"
                CornerRadius="8"
                Padding="10"
                HorizontalAlignment="Right"
                VerticalAlignment="Top"
                Margin="0,70,16,0"
                Panel.ZIndex="999"
                Visibility="Collapsed">
            <StackPanel>
                <TextBlock Text="Elegí tu impresora:" 
                          FontFamily="{DynamicResource TheSeasonsFont}"
                          FontSize="16"
                          Foreground="#8c52ff"
                          Margin="0,0,0,10"
                          FontWeight="Bold"/>
                <ListBox x:Name="PrinterListBox"
                        ItemsSource="{Binding AvailablePrinters}"
                        SelectedItem="{Binding SelectedPrinter}"
                        SelectionChanged="PrinterListBox_SelectionChanged"
                        MaxHeight="200"
                        BorderThickness="1"
                        BorderBrush="#8c52ff">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding}" 
                                      FontFamily="{DynamicResource TheSeasonsFont}"
                                      FontSize="14"
                                      Foreground="#8c52ff"
                                      Padding="5"/>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </StackPanel>
        </Border>

        <!-- Camera Selection Popup -->
        <Border x:Name="CameraPopup"
                Background="#E0000000"
                CornerRadius="12"
                Padding="20"
                HorizontalAlignment="Right"
                VerticalAlignment="Top"
                Margin="16,70,16,0"
                Visibility="Collapsed"
                Panel.ZIndex="999"
                MinWidth="400">
            <StackPanel>
                <TextBlock Text="Selecciona la cámara:" 
                          FontFamily="{DynamicResource TheSeasonsFont}"
                          FontSize="18"
                          Foreground="White"
                          Margin="0,0,0,15"/>
                <ListBox x:Name="CameraListBox"
                        ItemsSource="{Binding AvailableCameras}"
                        SelectedItem="{Binding SelectedCamera, Mode=TwoWay}"
                        DisplayMemberPath="Name"
                        FontFamily="{DynamicResource TheSeasonsFont}"
                        FontSize="16"
                        Background="#2A2A2A"
                        Foreground="#F5F5F5"
                        BorderBrush="#4A4A4A"
                        BorderThickness="2"
                        MaxHeight="300"
                        SelectionChanged="CameraListBox_SelectionChanged"/>
            </StackPanel>
        </Border>

        <!-- Idle Screen -->
        <Border x:Name="IdleScreen" 
                Background="Transparent"
                Panel.ZIndex="1"
                Visibility="{Binding IsIdle, Converter={StaticResource BoolToVisibilityConverter}}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <!-- Large Circular Start Button in Center -->
                <Button x:Name="StartButton"
                       Command="{Binding StartCommand}"
                       Background="#8c52ff"
                       BorderThickness="2"
                       BorderBrush="White"
                       Width="200"
                       Height="200"
                        IsEnabled="{Binding CanStart}"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       Grid.Row="0"
                       Cursor="Hand">
                    <Button.Template>
                        <ControlTemplate TargetType="Button">
                            <Border Background="{TemplateBinding Background}" 
                                    CornerRadius="100"
                                    Width="200"
                                    Height="200"
                                    BorderBrush="{TemplateBinding BorderBrush}"
                                    BorderThickness="{TemplateBinding BorderThickness}">
                                <Image x:Name="StartButtonIcon"
                                       Width="120" 
                                       Height="120"
                                       Stretch="Uniform"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"/>
                            </Border>
                        </ControlTemplate>
                    </Button.Template>
                    <Button.Style>
                        <Style TargetType="Button">
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#7a3fe6"/>
                                </Trigger>
                                <Trigger Property="IsEnabled" Value="False">
                                    <Setter Property="Background" Value="#666666"/>
                                    <Setter Property="BorderBrush" Value="#999999"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>
                
                <!-- Información del formato -->
                <TextBlock Grid.Row="1"
                          Text="Figurita Autoadhesiva 4.5 x 6 cm"
                          FontFamily="{DynamicResource TheSeasonsFont}"
                          FontSize="24"
                          Foreground="White"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Center"
                          Margin="0,0,0,20">
                    <TextBlock.Effect>
                        <DropShadowEffect Color="#000000" 
                                          Direction="270" 
                                          ShadowDepth="2" 
                                          Opacity="0.5" 
                                          BlurRadius="8"/>
                    </TextBlock.Effect>
                </TextBlock>
            </Grid>
        </Border>

        <!-- Countdown Overlay -->
        <Border x:Name="CountdownOverlay" 
                Background="#80000000" 
                Panel.ZIndex="2"
                Visibility="{Binding IsCountdown, Converter={StaticResource BoolToVisibilityConverter}}">
            <TextBlock Text="{Binding CountdownText}" 
                      FontSize="180" 
                                             FontFamily="{DynamicResource TheSeasonsFont}"
                      Foreground="White" 
                      FontWeight="Light"
                      HorizontalAlignment="Center"
                      VerticalAlignment="Center">
                <TextBlock.Effect>
                    <DropShadowEffect Color="#000000" 
                                      Direction="270" 
                                      ShadowDepth="4" 
                                      Opacity="0.8" 
                                      BlurRadius="20"/>
                </TextBlock.Effect>
            </TextBlock>
        </Border>

        <!-- Flash Overlay -->
        <Border x:Name="FlashOverlay" 
                Background="White" 
                Opacity="0"
                Visibility="Collapsed"/>

        <!-- Result Screen -->
        <Border x:Name="ResultScreen" 
                Background="#B0000000" 
                Visibility="{Binding IsResult, Converter={StaticResource BoolToVisibilityConverter}}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <TextBlock Text="Tu Foto" 
                          FontSize="42" 
                          FontFamily="{DynamicResource TheSeasonsFont}"
                          Foreground="White" 
                          FontWeight="Light"
                          HorizontalAlignment="Center"
                          Margin="0,0,0,40">
                    <TextBlock.Effect>
                        <DropShadowEffect Color="#000000" 
                                          Direction="270" 
                                          ShadowDepth="2" 
                                          Opacity="0.5" 
                                          BlurRadius="8"/>
                    </TextBlock.Effect>
                </TextBlock>
                <Border Background="White"
                        CornerRadius="12"
                        Padding="8"
                        Margin="0,0,0,40">
                    <Border.Effect>
                        <DropShadowEffect Color="#000000" 
                                          Direction="270" 
                                          ShadowDepth="4" 
                                          Opacity="0.3" 
                                          BlurRadius="16"/>
                    </Border.Effect>
                <Image Source="{Binding ResultStripImage}" 
                       MaxWidth="600" 
                       MaxHeight="1800"
                           Stretch="Uniform"/>
                </Border>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                    <Button Content="Guardar" 
                           Command="{Binding SaveCommand}"
                            Style="{StaticResource ModernButtonStyle}"
                            FontSize="18"
                            Padding="40,16"
                            MinWidth="140"
                            Margin="0,0,8,0"/>
                    <Button Content="Reiniciar" 
                           Command="{Binding RestartCommand}"
                            Style="{StaticResource ModernButtonStyle}"
                            FontSize="18"
                            Padding="40,16"
                            MinWidth="140"
                            Margin="8,0,0,0"/>
                </StackPanel>
            </StackPanel>
        </Border>
    </Grid>
</Window>

